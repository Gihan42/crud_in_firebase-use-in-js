<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style/index.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>
<body>
    <h1 class="main-title">crud-operation-in-firebase</h1>
<div class="main" >
   
  
    <div class="form-section shadow-lg p-9 bg-body-tertiary rounded">
        <div class="title">
            <h1 style="margin-left: 2%; margin-bottom: 2%;">customer-manage</h1>
            <div id="imageShow"></div>
        </div>
        <form action="" id ="formDetails">
                <div class="mb-3 ">
                    <label for="userId" class="form-label">user Id</label>
                    <input type="number" class="form-control" id="userId">
                    <div id="emailHelp" class="form-text">enter ur id.</div>
                </div>
                <div class="mb-3 ">
                    <label for="firstName" class="form-label">first name</label>
                    <input type="text" class="form-control" id="firstName" >
                    <div id="emailHelp" class="form-text">enter ur first name.</div>
                </div>
                <div class="mb-3">
                    <label for="lasttName" class="form-label">last name</label>
                    <input type="text" class="form-control" id="lastName" >
                    <div id="emailHelp" class="form-text">enter ur last name.</div>
                </div>
                <div class="mb-3">
                    <label for="age" class="form-label">age</label>
                    <input type="text" class="form-control" id="age" >
                    <div id="emailHelp" class="form-text">enter ur age.</div>
                </div>
                <div class="mb-3">
                    <label for="address" class="form-label">address</label>
                    <input type="text" class="form-control" id="address" >
                    <div id="emailHelp" class="form-text">enter ur address.</div>
                </div>
                    <div class="mb-3">
                        <label for="image" class="form-label">upload image</label>
                        <input type="file" class="form-control" id="imageInput"> 
                    </div>

        <button type="button" class="btn btn-primary" id="submit">save</button>
        <button type="button" class="btn btn-success" id="btnupdate">update</button>
        <button type="button" class="btn btn-danger" id="btndelete">delete</button>
        <button type="button" class="btn btn-warning" id="btnsearch">search</button>
        </form>
</div>

<div class="table-area">
    <button type="button" class="btn btn-success mb-3" id="excelBtn">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-excel-fill"
            viewBox="0 0 16 16">
            <path
                d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0zM9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1zM5.884 6.68 8 9.219l2.116-2.54a.5.5 0 1 1 .768.641L8.651 10l2.233 2.68a.5.5 0 0 1-.768.64L8 10.781l-2.116 2.54a.5.5 0 0 1-.768-.641L7.349 10 5.116 7.32a.5.5 0 1 1 .768-.64z" />
        </svg>
        got to excel sheet
    </button>
    <button type="button" class="btn btn-danger mb-3" id="cvsBtn">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
            class="bi bi-file-earmark-spreadsheet" viewBox="0 0 16 16">
            <path
                d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V9H3V2a1 1 0 0 1 1-1h5.5v2zM3 12v-2h2v2H3zm0 1h2v2H4a1 1 0 0 1-1-1v-1zm3 2v-2h3v2H6zm4 0v-2h3v1a1 1 0 0 1-1 1h-2zm3-3h-3v-2h3v2zm-7 0v-2h3v2H6z" />
        </svg>
        got to cvs sheet
    </button>
                                            <table class="table" id="user">
                                                <thead>
                                                    <tr>
                                                        <th >id</th>
                                                        <th >first name</th>
                                                        <th >last name</th>
                                                        <th>age</th>
                                                        <th >address</th>
                                                        <th>image</th>
                                                        
                                                    </tr>
                                                </thead>
                                                <tbody id="tbodyData">
                                            
                                                </tbody>
                                       
                </table>
</div>
</div>
    <script src="jquery-3.6.1.min.js"></script>
    <script src="./script/index.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/7.14.1-0/firebase.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-storage.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-database.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>

   <script type="module">
        // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyASdZbTizGh1XoioID28KGe-0BG8KkMpsA",
        authDomain: "fire9db-63e87.firebaseapp.com",
        databaseURL: "https://fire9db-63e87-default-rtdb.firebaseio.com",
        projectId: "fire9db-63e87",
        storageBucket: "fire9db-63e87.appspot.com",
        messagingSenderId: "520615579420",
        appId: "1:520615579420:web:b9effb894d54f9272ff4d9"
    };

    firebase.initializeApp(firebaseConfig);
    var database = firebase.database();
    var details = firebase.database().ref('fire9db');
   
$(document).ready(function () {
         getAllData();
         $('#tbodyData > tr').click(function () {
            alert('click row')
           let userId = $(this).children(":eq(0)").text();
           let fName = $(this).children(":eq(1)").text();
           let lName = $(this).children(":eq(2)").text();
           let age = $(this).children(":eq(3)").text();
           let address = $(this).children(":eq(4)").text();
           console.log('====================================');
           console.log(userId, lName, fName, age, address);
           console.log('====================================');
             $('#firstName').val(fName);
             $('#lastName').val(lName);
             $('#age').val(age);
             $('#address').val(address);
             $('#userId').val(userId);
   
       });
        });
   
$('#submit').click(function () {
        uploadImage();
    });

function uploadImage() {
        var fName = $('#firstName').val();
        var lName = $('#lastName').val();
        var age = $('#age').val();
        var add = $('#address').val();
        var userId = $('#userId').val();

        var fileInput = document.getElementById("imageInput");
        var file = fileInput.files[0];
        if (file) {
            // Create a storage reference
            var storageRef = firebase.storage().ref("images/" + file.name);

            // Upload the file
            storageRef.put(file).then(function (snapshot) {
                alert("Image uploaded successfully!");

                // Get the download URL for the image
                snapshot.ref.getDownloadURL().then(function (downloadURL) {
                    // Save the download URL in the database
                    saveDataToDatabase(userId, fName, lName, age, add, downloadURL);
                });
            });
        } else {
            console.error("No file selected");
        }
    }

function saveDataToDatabase(userId, fName, lName, age, add, imageUrl) {
        // Get a reference to the database
        var database = firebase.database();

        // Push the download URL and input field value to the "images" node
        database.ref("fire9db").push({
            id: userId,
            firstname: fName,
            lastname: lName,
            age: age,
            address: add,
            image: imageUrl
        });
        $('#formDetails')[0].reset();
        getAllData();
        console.log("Image URL and input value saved to the database");
    }

function getAllData() {
            details.once('value', function (snapshot) {
                var data = snapshot.val();
                $('#tbodyData').empty();
                for (let i in data) {
                    if (data.hasOwnProperty(i)) {
                        let user = data[i];
                        $('#tbodyData').append(`<tr><td>` + user.id + `</td><td>` + user.firstname + `</td><td>` + user.lastname + `</td><td>` + user.age + `</td><td>` + user.address + `</td><td>` + `<img src="${user.image}" width="35px" style=" border-radius: 50%; height: 33px; width: 33px" alt=""> ` + `</td><td>` + `</td></tr>`);
                    }
                }
            });
        };

$('#btnupdate').click(function () {
        updateImageAndData();
    });

function updateImageAndData() {
        var fName = $('#firstName').val();
        var lName = $('#lastName').val();
        var age = $('#age').val();
        var add = $('#address').val();
        var userId = $('#userId').val();
        

        var fileInput = document.getElementById("imageInput");
        var file = fileInput.files[0];

        if (file) {
            var storageRef = firebase.storage().ref("images/" + file.name);

            storageRef.put(file).then(function (snapshot) {
                alert("Image uploaded successfully!");

                snapshot.ref.getDownloadURL().then(function (downloadURL) {
                    updateDataToDatabase(userId, fName, lName, age, add, downloadURL);
                });
            });
        } else {
            console.error("No file selected");
        }
    }

function updateDataToDatabase(userId, fName, lName, age, add, imageUrl) {
        var query = details.orderByChild("id").equalTo(userId);
        query.once('value', function (snapshot) {
            if (snapshot.exists() ) {
                var data = snapshot.val();
                console.log('Data to be updated:', JSON.stringify(data));

                var key = Object.keys(data)[0];

                var newData = {
                    id: userId,
                    firstname: fName,
                    lastname: lName,
                    age: age,
                    address: add,
                    image: imageUrl
                };

                details.child(key).update(newData)
                    .then(function () {
                        alert('Data updated successfully.');
                        getAllData();
                        $('#formDetails')[0].reset();
                    })
                    .catch(function (error) {
                        console.error('Error updating data:', error);
                    });
            } else {
                console.log('Data does not exist.');
            }
        });
    }

$('#btnsearch').click(function(){
    var userId = $('#userId').val();
   var query= details.orderByChild("id").equalTo(userId);
    query.once('value',function (snapshot) {
            // Handle the snapshot
            var data= snapshot.val();
           $('#imageShow').empty();
               for (let i in data) {
                 if (data.hasOwnProperty(i)) {
                 let user = data[i];
                $('#firstName').val(user.firstname);
                $('#lastName').val(user.lastname);
                $('#age').val(user.age);
                $('#address').val(user.address);
                 $('#imageShow').append(`<img src="${user.image}" width="85px" style=" border-radius: 50%; height: 73px; width: 73px" alt="">`);
                console.log(user.image)
                 $('#imageInput').attr('src', user.image);
            };
               };
        })
        .catch(function (error) {
            alert("Error fetching data:", error);
        });
});
$('#btndelete').click(function(){
    var userId = $('#userId').val();
   var query= details.orderByChild("id").equalTo(userId);
    query.once('value', function (snapshot) {
        if(snapshot.exists()){
              var data = snapshot.val();
            console.log('tiynawa'+ JSON.stringify(data));
            var key = Object.keys(data)[0];

            // Remove the data
            details.child(key).remove()
                .then(function () {
                    alert('Data deleted successfully.');
                    getAllData();
                    $('#formDetails')[0].reset();
                })
                .catch(function (error) {
                    console.error('Error deleting data:', error);
                });
        }

        
    });
})
$('#excelBtn').click(function(){
    // Get table data
    var table = document.getElementById("user");
    var rows = table.getElementsByTagName("tr");

    // Create a new Excel Workbook
    var workbook = XLSX.utils.book_new();
    var worksheet = XLSX.utils.table_to_sheet(table);

    // Add the worksheet to the workbook
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');

    // Save the workbook as a file
    XLSX.writeFile(workbook, 'table_data.xlsx');


});
$('#cvsBtn').click(function(){
    let csvContent = "data:text/csv;charset=utf-8,";

    // Add header row
    const headerRow = $("#user th").map(function () {
        return $(this).text();
    }).get();
    csvContent += headerRow.join(",") + "\n";

    // Add data rows
    $("#user tbody tr").each(function () {
        const dataRow = $(this).find("td").map(function () {
            return $(this).text();
        }).get();
        csvContent += dataRow.join(",") + "\n";
    });

    // Create a data URI and initiate a download
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "data.csv");
    document.body.appendChild(link); // Required for Firefox
    link.click();
    document.body.removeChild(link);
});

   </script>


</body>
</html>